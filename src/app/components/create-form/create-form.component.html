<!-- TOP ACTIONS -->
<mat-toolbar color="primary" class="topbar">
  <span class="toolbar-title">Dashboard</span>
  <span class="spacer"></span>
</mat-toolbar>


<!-- ===== LIST VIEW ===== -->
<div *ngIf="!showFormEditor" class="templates-container page">

  <div class="page-header-row">
    <h2 class="page-title">Forms</h2>

    <div class="actions-row">
      <div class="pill-tabs">
        <button
          mat-raised-button
          class="tab-btn tofill"
          [class.active]="viewMode==='tofill'"
          (click)="showFormsToFill()">
          <mat-icon>assignment</mat-icon>
          Forms to Fill
        </button>

        <button
          type="button"
          class="tab-btn filled"
          [class.active]="viewMode==='filled'"
          (click)="showFilledForms()">
          <mat-icon class="tab-icon">inventory_2</mat-icon>
          <span>Filled Forms</span>
        </button>
      </div>

      <button mat-flat-button color="primary" (click)="loadForms()">
        <mat-icon>folder</mat-icon>
        Load Local
      </button>

      <button mat-flat-button color="accent" (click)="loadFormsFromFirebase()">
        <mat-icon>cloud_download</mat-icon>
        Load Firebase
      </button>
    </div>
  </div>

  <!-- Empty state -->
  <mat-card *ngIf="viewMode==='default' && (!forms || !forms.length)" class="section-card empty-card">
    <mat-card-content class="empty">
      <mat-icon class="empty__icon">inbox</mat-icon>
      <div class="empty__title">No templates yet</div>
      <div class="empty__subtitle">Load from LocalStorage or Firebase to get started.</div>
    </mat-card-content>
  </mat-card>

  <!-- Templates to fill -->
  <ng-container *ngIf="viewMode === 'tofill' && templates?.length">
    <mat-card class="section-card">
      <mat-card-header>
        <mat-card-title>Forms to Fill</mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <ul class="forms-list">
          <li class="form-row" *ngFor="let form of templates; trackBy: trackByFormId">
            <div class="left">
              <mat-icon class="doc">description</mat-icon>
              <div class="meta">
                <div class="name" [title]="form.formName">{{ form.formName || 'Untitled Template' }}</div>
                <div class="sub">Template</div>
              </div>
            </div>
            <div class="actions">
              <button mat-icon-button matTooltip="Fill" aria-label="Fill"
                      (click)="$event.stopPropagation(); openForm(form)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Download" aria-label="Download"
                      (click)="$event.stopPropagation(); onClickDownloadIcon(form)">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Delete" aria-label="Delete"
                      (click)="$event.stopPropagation(); deleteForm(form)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </li>
        </ul>
      </mat-card-content>
    </mat-card>
  </ng-container>

  <!-- Filled forms -->
  <ng-container *ngIf="viewMode === 'filled'">
    <mat-card *ngIf="filledForms?.length; else noFilled" class="section-card forms-card">
      <mat-card-header>
        <mat-card-title>Filled Forms</mat-card-title>
        <span class="spacer"></span>
      </mat-card-header>

      <mat-card-content>
        <ul class="forms-list">
          <li class="form-row" *ngFor="let form of filledForms">
            <div class="left">
              <mat-icon class="doc filled">assignment</mat-icon>
              <div class="meta">
                <div class="name" [title]="form.formName">{{ form.formName || 'Untitled Filled Form' }}</div>
                <div class="sub">Filled</div>
              </div>
            </div>
            <div class="actions">
              <button mat-icon-button matTooltip="Open" aria-label="Open"
                      (click)="$event.stopPropagation(); openForm(form)">
                <mat-icon>edit</mat-icon>
              </button>
              <button mat-icon-button matTooltip="Download" aria-label="Download"
                      (click)="$event.stopPropagation(); onClickDownloadIcon(form)"
                      [disabled]="downloading.has(asKey(form.formId))">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button color="warn" matTooltip="Delete" aria-label="Delete"
                      (click)="$event.stopPropagation(); deleteForm(form)">
                <mat-icon>delete</mat-icon>
              </button>
            </div>
          </li>
        </ul>
      </mat-card-content>
    </mat-card>

    <ng-template #noFilled>
      <mat-card class="section-card empty-card">
        <mat-card-content class="empty">
          <mat-icon class="empty__icon">inbox</mat-icon>
          <div class="empty__title">No filled forms yet</div>
          <div class="empty__subtitle">Click “Load Firebase” or “Load Local”.</div>
        </mat-card-content>
      </mat-card>
    </ng-template>
  </ng-container>

</div>

<!-- ===== EDITOR VIEW ===== -->
<div *ngIf="showFormEditor && selectedForm" class="view-root editor-content">

  <mat-toolbar class="editor-toolbar" color="primary">
    <button mat-icon-button (click)="closeForm()" aria-label="Back">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <span class="toolbar-title">Fill/Edit: {{ selectedForm.formName }}</span>
    <span class="spacer"></span>
<ng-container *ngIf="selectedForm as sf">
  <button
    *ngIf="sf.source === 'filled'"
    mat-icon-button
    [disabled]="isDownloading(sf.formId)"
    [matTooltip]="pdfTooltip(sf)"
    (click)="$event.stopPropagation(); onClickDownloadIcon(sf)"
    aria-label="Download PDF"
  >
    <mat-icon [class.spin]="isDownloading(sf.formId)">
      {{ hasPdf(sf) ? 'download' : 'picture_as_pdf' }}
    </mat-icon>
  </button>
</ng-container>
  </mat-toolbar>

  <!-- Inline naming / save bar -->
  <div class="form-action-toolbar">
    <ng-container *ngIf="!showNameInput">
      <button mat-raised-button color="primary" type="button" (click)="savePDFPreview()">
        <mat-icon>save</mat-icon>
        Save
      </button>
    </ng-container>

    <ng-container *ngIf="showNameInput">
    <mat-form-field appearance="outline" [floatLabel]="'auto'">
        <mat-label>Enter form name</mat-label>
        <input matInput [(ngModel)]="filledDataName" [ngModelOptions]="{ standalone: true }" required />
        <mat-error *ngIf="nameError">Please enter a valid name.</mat-error>
      </mat-form-field>

      <button mat-stroked-button color="primary" type="button" (click)="confirmSaveFilledForm()">
        Confirm
      </button>
      <button mat-button type="button" (click)="cancelSave()">Cancel</button>
    </ng-container>
  </div>


      <ng-template #saveLoadChoiceTpl let-data>
    <h2 mat-dialog-title>{{ data?.mode === 'save' ? 'Choose Save Location' : 'Load From' }}</h2>
    <mat-dialog-content>
      <p *ngIf="data?.mode === 'save'">Where do you want to save?</p>
      <p *ngIf="data?.mode === 'load'">Where do you want to load from?</p>
    </mat-dialog-content>
    <mat-dialog-actions align="end">
      <button mat-button [mat-dialog-close]="null" cdkFocusInitial>Cancel</button>
      <button mat-raised-button color="primary" [mat-dialog-close]="'firebase'">Firebase</button>
      <button mat-button [mat-dialog-close]="'local'">Local storage</button>
      <button mat-button *ngIf="data?.mode === 'save'" [mat-dialog-close]="'both'">Both</button>
    </mat-dialog-actions>
  </ng-template>
<div class="editor-scroll">
  <mat-card class="editor-card">
    <mat-card-content>

      <canvas #pdfCanvas style="display:none"></canvas>

      <!-- A4 wrapper -->
      <div class="page-frame">
        <div id="pageFill" class="page-sheet">
          <div class="page-equalizer">

            <!-- your actual form lives inside the sheet -->
            <div id="form-to-export" class="form-export-surface" [style.padding.px]="0">
              <form id="dynamicForm" novalidate>

                <div *ngFor="let page of selectedForm.formPages; let p = index" class="page-container">
                  <div class="page-header">
                    <span class="page-title">Page {{ p + 1 }}</span>
                  </div>

                  <div class="page-surface sheet-surface"
     style="position: relative"
     (dragover)="showFormEditor && onPageDragOver($event)"
     (drop)="showFormEditor && onPageDrop($event)"
     (mousedown)="onPageMouseDown($event, p)">

  <div class="form-page-container">
    <!-- FIELDS -->
    <div *ngFor="let field of page.fields"
         class="field-wrapper"
         [class.fill-mode]="true"
         [class.dir-row]="(field.ui?.direction || 'row') === 'row'"
         [class.dir-col]="(field.ui?.direction || 'row') === 'column'"
         [class.inline-row]="isInlineRow(field)"
         [class.stack]="!isInlineRow(field)"
         [class.desc-resize]="isDescriptionField(field)"
         [attr.data-id]="field.id"
         [ngStyle]="getFieldStyle(field)"
         (mousedown)="onWrapperMouseDown($event, field)">
                        <!-- Label (skip for grid types) -->
                        <label class="field-label"
                               *ngIf="!(field.type==='data-grid' || field.type==='datagrid' || field.type==='grid' || field.type==='matrix' || isDescriptionField(field))"
                               [attr.for]="field.id"
                               [attr.id]="field.id + '__label'">
                          {{ field.label }} <span *ngIf="field.required" class="req">*</span>
                        </label>

                        <!-- Data Grid / Matrix -->
                        <ng-container *ngIf="isDG(field)">
                          <div class="data-grid-matrix fill-mode tight"
                               role="group"
                               [attr.aria-labelledby]="$any(field).id + '__label'"
                               [ngStyle]="controlStyle($any(field))"
                               [style.width.%]="100"
                               [style.height.px]="$any(field).height">

                            <div class="dg-header">
                              <strong [attr.id]="$any(field).id + '__label'">
                                {{ $any(field).label || 'Data Grid' }}
                              </strong>
                              <span *ngIf="$any(field).required" aria-hidden="true" style="color:#d32f2f;">*</span>
                            </div>

                            <div class="dg-grid"
                                 [style.display]="'grid'"
                                 [style.gridTemplateColumns]="gridColsCss($any(field))"
                                 [style.gridAutoRows.px]="$any(field).gridMatrix?.cellH || 140"
                                 [style.gap.px]="$any(field).gridMatrix?.gap || 12"
                                    [style.width.%]="100"
                                   [style.height.%]="100"
                                 [style.boxSizing]="'border-box'">
                              <ng-container *ngFor="let row of $any(field).gridMatrix?.cells; let r = index; trackBy: trackByIndex">
                                <ng-container *ngFor="let cell of row; let c = index; trackBy: trackByIndex">
                                  <div class="dg-cell"
                                  [class.is-empty]="!(cell?.items && cell.items.length)"
                                       (dragover)="onCellDragOver($event)"
                                       (drop)="onCellDrop($event, $any(field), r, c)"
                                       [class.is-empty]="!(cell?.items && cell.items.length)"
                                       [class.bordered]="$any(field).gridMatrix?.showBorders">

                                    <ng-container *ngIf="(cell?.items?.length || 0) > 0; else emptyCell">
                                      <div class="dg-item"
                                           *ngFor="let it of cell.items; trackBy: trackByIndex"
                                           [ngStyle]="gridItemAbsoluteStyle(it, $any(field))">

                                        <div *ngIf="it.label" style="font-size:12px;color:#555;margin-bottom:4px;">{{ it.label }}</div>

                                        <ng-container [ngSwitch]="(it.type || 'text')">
                                          <textarea *ngSwitchCase="'textarea'" [(ngModel)]="it.value" [ngModelOptions]="{standalone:true}"
                                                    rows="4" style="width:100%;height:100%;box-sizing:border-box;resize:none;"></textarea>

                                          <input *ngSwitchCase="'number'" type="number" [(ngModel)]="it.value" [ngModelOptions]="{standalone:true}"
                                                 style="width:100%;height:100%;box-sizing:border-box;" />

                                          <input *ngSwitchCase="'date'" type="date" [(ngModel)]="it.value" [ngModelOptions]="{standalone:true}"
                                                 style="width:100%;height:100%;box-sizing:border-box;" />

                                          <select *ngSwitchCase="'select'" [(ngModel)]="it.value" [ngModelOptions]="{standalone:true}"
                                                  style="width:100%;height:100%;box-sizing:border-box;">
                                            <option *ngFor="let opt of (it.options || [])" [value]="opt?.value ?? opt">
                                              {{ opt?.label || opt }}
                                            </option>
                                          </select>

                                          <input *ngSwitchCase="'file'" type="file" (change)="onGridFile($event, it)" style="width:100%;" />

                                          <input *ngSwitchDefault type="text" [(ngModel)]="it.value" [ngModelOptions]="{standalone:true}"
                                                 style="width:100%;height:100%;box-sizing:border-box;" />
                                        </ng-container>
                                      </div>
                                    </ng-container>

                                    <ng-template #emptyCell>
                                      <div class="dg-empty" style="color:#999;text-align:center;padding:12px;">—</div>
                                    </ng-template>
                                  </div>
                                </ng-container>
                              </ng-container>
                            </div>

                            <div class="req-msg"
                                 *ngIf="$any(field).required && !gridHasAnyValue($any(field))"
                                 style="color:#d32f2f; font-size:12px; margin-top:6px;">
                              * Required: please enter at least one value.
                            </div>
                          </div>
                        </ng-container>

                        <!-- Date -->
                        <ng-container *ngIf="field.type === 'date'">
                          <div class="fw-control" [style.height.px]="getAdjustedHeight(field.height)">
                            <mat-form-field appearance="outline" class="fw-field">
                              <input matInput
                                     class="date-input"
                                     type="text"
                                     inputmode="numeric"
                                     placeholder="dd / mm / yyyy"
                                     [(ngModel)]="field.value"
                                     [name]="field.id"
                                     [required]="!!field.required"
                                     [attr.aria-labelledby]="field.id + '__label'"
                                     (input)="onDateInput($event, field)"
                                     (blur)="onDateBlur($event, field)"
                                     (focus)="onDateFocus($event)"
                                     (mousedown)="onDateMouseDown($event)"
                                     #dateModel="ngModel">

                              <button mat-icon-button
                                      matSuffix
                                      type="button"
                                      (mousedown)="$event.stopPropagation()"
                                      (click)="openNativePicker(nativeDate)"
                                      aria-label="Open calendar">
                                <mat-icon>event</mat-icon>
                              </button>

                              <input #nativeDate
                                     type="date"
                                     class="native-date-hidden"
                                     [value]="toNativeDate(field.value)"
                                     (change)="onNativeDateChange($event, field)">

                              <mat-error *ngIf="field.required && dateModel.invalid">
                                This field is required.
                              </mat-error>
                            </mat-form-field>
                          </div>
                        </ng-container>

                        <!-- Text / Email / Number / Tel -->
                        <ng-container *ngIf="field.type === 'text' || field.type === 'email' || field.type === 'number' || field.type === 'tel' || !field.type">
                          <div class="fw-control" [style.height.px]="getAdjustedHeight(field.height)">
                            <mat-form-field appearance="outline" class="fw-field">
                              <input matInput
                                     [type]="field.type || 'text'"
                                     [(ngModel)]="field.value"
                                     [name]="field.id"
                                     [id]="field.id"
                                     [required]="!!field.required"
                                     [placeholder]="field.placeholder || ''"
                                     #inputRef="ngModel" />
                              <mat-error *ngIf="inputRef.invalid && (inputRef.dirty || inputRef.touched)">
                                This field is required.
                              </mat-error>
                            </mat-form-field>
                          </div>
                        </ng-container>

                        <!-- Checkbox -->
                        <ng-container *ngIf="field.type === 'checkbox'">
                          <div class="checkbox-group"
                               role="group"
                               [attr.aria-labelledby]="field.id + '__label'">
                            <mat-checkbox
                              *ngFor="let opt of (field.options || []); let i = index"
                              [(ngModel)]="opt.checked"
                              [ngModelOptions]="{ standalone: true }"
                              [attr.id]="field.id + '_chk_' + i"
                              (ngModelChange)="onCheckboxToggle(field)">
                              {{ opt.label }}
                            </mat-checkbox>
                          </div>
                          <div *ngIf="field.required && !hasAnyChecked(field)"
                               style="color:#d32f2f; font-size:12px;">
                            * Required: select at least one option.
                          </div>
                        </ng-container>

                        <!-- Project Title -->
                        <ng-container *ngIf="field.type === 'project-title'">
                          <input type="text" [(ngModel)]="field.value" [name]="field.id" [id]="field.id"
                                 placeholder="Enter project name" required class="w-100" />
                        </ng-container>

                        <!-- Textarea / Description -->
<ng-container *ngIf="field.type === 'textarea' || field.type === 'description'">
  <ng-container *ngIf="isDescriptionField(field); else normalTextarea">

    <div class="desc-field-box">
      <div class="desc-label">{{ field.label }} <span *ngIf="field.required" class="req">*</span></div>

      <div class="desc-body">
        <div *ngFor="let item of (field.problemItems || []); let i = index" class="desc-row">
          <span class="desc-no">{{ item.no }}.</span>

          <textarea class="desc-input"
                    [ngModel]="item.text"
                    (ngModelChange)="updateProblemText(field, i, $event)"
                    [ngModelOptions]="{ standalone: true }"
                    placeholder="Write problem description...">
          </textarea>

          <button *ngIf="isBuilderMode"
                  mat-icon-button type="button"
                  (click)="removeProblemItem(field, i)"
                  aria-label="Remove">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>
    </div>

  </ng-container>

  <ng-template #normalTextarea>
    <textarea [(ngModel)]="field.value"
              [name]="field.id"
              [id]="field.id"
              class="textarea-resizable-both"
              [placeholder]="field.placeholder || ''">
    </textarea>
  </ng-template>
</ng-container>

                        <!-- Select (branch) -->
                        <ng-container *ngIf="field.type === 'branch' && field.options">
                          <div class="fw-control" [style.height.px]="getAdjustedHeight(field.height)">
                            <mat-form-field appearance="outline" class="fw-field">
                              <mat-label>Select</mat-label>
                              <mat-select [(ngModel)]="field.value"
                                          [name]="field.id"
                                          [id]="field.id"
                                          [required]="!!field.required"
                                          #selectRef="ngModel">
                                <mat-option [value]="''">-- Select --</mat-option>
                                <mat-option *ngFor="let opt of field.options" [value]="opt.value">
                                  {{ opt.label }}
                                </mat-option>
                              </mat-select>
                              <mat-error *ngIf="selectRef.invalid && (selectRef.dirty || selectRef.touched)">
                                This field is required.
                              </mat-error>
                            </mat-form-field>
                          </div>
                        </ng-container>

                        <!-- Radio -->
                        <div *ngIf="field.type === 'radio' && field.options"
                             class="radio-group"
                             role="radiogroup"
                             [attr.aria-labelledby]="field.id + '__label'">
                          <label *ngFor="let opt of field.options; let i = index"
                                 class="radio-option"
                                 [attr.for]="field.id + '_opt_' + i">
                            <input type="radio"
                                   [id]="field.id + '_opt_' + i"
                                   [name]="field.id"
                                   [value]="opt.value"
                                   [(ngModel)]="field.value"
                                   [required]="!!field.required">
                            {{ opt.label }}
                          </label>
                        </div>

                        <!-- File -->
                        <ng-container *ngIf="field.type === 'file'">
                          <input type="file" accept="image/*" (change)="onFileSelected($event, field)" />
                          <img *ngIf="field.value" [src]="field.value" alt="Uploaded photo" class="uploaded-img" />
                        </ng-container>

                   <div *ngIf="field.type === 'signature'"
     (pointerdown)="$event.stopPropagation()" 
     (mousedown)="$event.stopPropagation()">

  <canvas #canvas
          class="signature-canvas"
          [attr.data-id]="field.id"

     
          [style.width.px]="field.width || 300"
          [style.height.px]="getSignatureCanvasHeight(field.height)"

    
          [attr.width]="field.width || 300"
          [attr.height]="getSignatureCanvasHeight(field.height)"

          [style.touchAction]="'none'"                
          (pointerdown)="startDrawing($event, field.id); $event.stopPropagation()"
          (pointermove)="draw($event, field.id)"
          (pointerup)="stopDrawing($event, field.id)"
          (pointerleave)="stopDrawing($event, field.id)">
  </canvas>

  <button mat-stroked-button type="button" data-nonprint (click)="clearSignatureCanvas(field.id)">
    Clear Signature
  </button>
</div>
                      </div>
                      <!-- /FIELD LOOP -->

                    </div> <!-- /.form-page-container -->
                  </div>   <!-- /.page-surface -->
                </div>     <!-- /.page-container -->

              </form>
            </div> <!-- /#form-to-export -->

          </div> <!-- /.page-equalizer -->
        </div>   <!-- /#pageFill -->
      </div>     <!-- /.page-frame -->

    </mat-card-content>
  </mat-card>
</div>
 
